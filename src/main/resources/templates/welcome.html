<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="/css/style.css" rel="stylesheet" />
<title>Insert title here</title>

<script>
  /*
   * ç”»é¢è¡¨ç¤ºæ™‚ (onLoad) ã«å‹•ä½œã™ã‚‹å‡¦ç†ç¾¤
   */
  document.addEventListener("DOMContentLoaded", event => {
    
    // å•†å“æƒ…å ±ã®ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦æŠ½å‡ºã—ã€deleteBtnsã«æ ¼ç´ã™ã‚‹
    const deleteBtns = document.querySelectorAll(".deleteBtn");
    
    // deleteBtn ã‚’ãƒ«ãƒ¼ãƒ—ã•ã›ã€ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¿½åŠ ã™ã‚‹
    deleteBtns.forEach(btn => {
      //"click" ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãŸéš› ç„¡åé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã‚ˆã†è¨­å®šã™ã‚‹
      btn.addEventListener("click", event => {
        let isOk = confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
        if (!isOk) { return; }
        
        // event.target(å‰Šé™¤ãƒœã‚¿ãƒ³)ã®è¦ªè¦ç´ ã®ã•ã‚‰ã«è¦ªè¦ç´ ã‹ã‚‰ã€"td"è¦ç´ ã‚’ã™ã¹ã¦æŠ½å‡ºã—ã€tdListã«æ ¼ç´ã™ã‚‹
        const tdList = event.target.parentElement.parentElement.querySelectorAll("td");
        // deleteGoods é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€å•†å“æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹
        deleteGoods(tdList);
      });
    });
    
  });
  
  /*
   * deleteGoodsé–¢æ•°
   *
   */
   function deleteGoods(tdList) {
     // Javaã«POSTé€ä¿¡ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ãƒ»è¨­å®šã™ã‚‹
     const postObj = {"id": tdList.item(0).innerText };
     
     /*
      * fetch API ã‚’ä½¿ç”¨ã—ã€‚JAVAã¨éåŒæœŸé€šä¿¡(POST)ã‚’è¡Œã†
      * SUCCESSæ™‚(than): å‰Šé™¤å‡¦ç†å®Œäº†ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã€ç”»é¢ä¸Šã®å•†å“æƒ…å ±è¡Œã‚’å‰Šé™¤ã™ã‚‹
      *ã€€ERRORæ™‚(catch): ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ console ã«å‡ºåŠ›ã™ğŸ„¬
      */
      
     fetch("/ecsite/admin/api/deleteGoods" , {
       method: "POST",
       headers: {'Content-Type': "application/json" },
       body: JSON.stringify(postObj),
       })
       .then(response => response.text())
       .then(result => {
         alert(`å•†å“ [ ${tdList.item(1).innerText}]ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
         tdList.item(0).parentElement.remove();
         })
         .catch(error => {
           console.error("Error: ",error);
         })
       }
   
  </script>
</head>
<body>

<header>
  <h1>EC Site--ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
</header>
 
 <table id="adminTable">
   <thread>
     <tr>
       <th>ID</th><th>å•†å“å</th><th>ä¾¡æ ¼</th><th>å‰Šé™¤</th>
     </tr>
   </thread>
   <tbody>
     <tr th:each="item: ${goods}">
       <td th:text="${item.id}" />
       <td th:text="${item.goodsName}" />
       <td th:text="${item.price}" />    
       <td><button type="submit" class="deleteBtn">å‰Šé™¤</button></td>
     </tr>
   </tbody>
  </table>
     
  <form name="goodsForm" id="adminPage" method="post" action="/ecsite/admin/goodsMst">
    
    <button type="submit" th:if="${userName != null}">æ–°è¦å•†å“è¿½åŠ </button>
    <input type="hidden" name="userName"th:value="${userName}"/>   
    <input type="hidden" name="password"th:value="${password}"/> 
    
  </form>
  
</body>
</html>